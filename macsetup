#!/bin/bash
# macsetup -- declarative macOS setup with Nix
#
# Usage: macsetup <command> [args]
#
# Wraps darwin-rebuild with automatic generation management.
# Keeps the last 3 generations after every mutating operation.

set -euo pipefail

# ---------------------------------------------------------------------------
# Resolve repo root
# ---------------------------------------------------------------------------

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ ! -f "$REPO_ROOT/flake.nix" ]; then
  echo ""
  echo "ERROR: flake.nix not found at $REPO_ROOT/flake.nix"
  echo "Run this script from within the macsetup repository."
  echo ""
  exit 1
fi

# ---------------------------------------------------------------------------
# Helper functions
# ---------------------------------------------------------------------------

info() {
  echo "==> $*"
}

error() {
  echo ""
  echo "ERROR: $*"
  echo ""
  exit 1
}

gc() {
  info "Pruning old generations (keeping last 3)..."
  sudo nix-env -p /nix/var/nix/profiles/system --delete-generations +3
  info "Collecting garbage..."
  sudo nix-collect-garbage
  info "Garbage collection complete."
}

usage() {
  cat <<EOF
macsetup -- declarative macOS setup with Nix

Usage: macsetup <command> [args]

Commands:
  bootstrap     First-time setup (install Nix + nix-darwin)
  rebuild       Apply configuration changes (darwin-rebuild switch)
  update        Update all Nix inputs and rebuild
  rollback      Revert to the previous generation
  switch N      Switch to generation N
  list          Show generation history
  capture       Audit current Mac and import unmanaged items

Options:
  -h, --help    Show this help message

After rebuild, update, rollback, and switch, old generations are
automatically pruned (keeping the last 3) and garbage collected.
EOF
}

# ---------------------------------------------------------------------------
# Subcommands
# ---------------------------------------------------------------------------

cmd_bootstrap() {
  if command -v darwin-rebuild &>/dev/null; then
    error "This Mac has already been bootstrapped (darwin-rebuild found). Use 'macsetup rebuild' instead."
  fi
  if [ ! -f "$REPO_ROOT/scripts/bootstrap.sh" ]; then
    error "bootstrap.sh not found at $REPO_ROOT/scripts/bootstrap.sh"
  fi
  exec "$REPO_ROOT/scripts/bootstrap.sh"
}

cmd_rebuild() {
  info "Rebuilding system configuration..."
  cd "$REPO_ROOT"
  sudo darwin-rebuild switch --flake .#macsetup
  gc
  info "Rebuild complete."
}

cmd_update() {
  info "Updating flake inputs..."
  cd "$REPO_ROOT"
  nix flake update
  info "Flake inputs updated. Rebuilding..."
  sudo darwin-rebuild switch --flake .#macsetup
  gc
  info "Update complete."
}

cmd_rollback() {
  info "Rolling back to previous generation..."
  sudo darwin-rebuild --rollback
  gc
  info "Rollback complete."
}

cmd_switch() {
  local gen="$1"
  if ! [[ "$gen" =~ ^[1-9][0-9]*$ ]]; then
    error "Invalid generation number: $gen (must be a positive integer)"
  fi
  info "Switching to generation $gen..."
  sudo darwin-rebuild --switch-generation "$gen"
  gc
  info "Switched to generation $gen."
}

cmd_list() {
  sudo darwin-rebuild --list-generations
}

cmd_capture() {
  if ! command -v darwin-rebuild &>/dev/null; then
    error "This Mac has not been bootstrapped yet. Run 'macsetup bootstrap' first."
  fi
  if [ ! -f "$REPO_ROOT/scripts/capture.sh" ]; then
    error "capture.sh not found at $REPO_ROOT/scripts/capture.sh"
  fi
  exec "$REPO_ROOT/scripts/capture.sh"
}

# ---------------------------------------------------------------------------
# Main dispatch
# ---------------------------------------------------------------------------

if [ $# -eq 0 ]; then
  usage
  exit 1
fi

case "$1" in
  bootstrap)
    cmd_bootstrap
    ;;
  rebuild)
    cmd_rebuild
    ;;
  update)
    cmd_update
    ;;
  rollback)
    cmd_rollback
    ;;
  switch)
    if [ $# -lt 2 ]; then
      error "Usage: macsetup switch <generation-number>"
    fi
    cmd_switch "$2"
    ;;
  list)
    cmd_list
    ;;
  capture)
    cmd_capture
    ;;
  -h|--help)
    usage
    ;;
  *)
    echo "Unknown command: $1"
    echo ""
    usage
    exit 1
    ;;
esac
